{"version":3,"file":"RoomAndToDeviceKeyTransport.js","names":["logger","rootLogger","KeyTransportEvents","NotSupportedError","TypedEventEmitter","RoomAndToDeviceEvents","RoomAndToDeviceTransport","constructor","toDeviceTransport","roomKeyTransport","parentLogger","_this","this","_defineProperty","toDevice","room","getChild","setParentLogger","on","ReceivedKeys","_enabled","debug","setEnabled","_len","arguments","length","props","Array","_key","emit","_len2","_key2","enabled","EnabledTransportsChanged","start","stop","sendKey","keyBase64Encoded","index","members","_this2","_asyncToGenerator","concat","error","warn"],"sources":["../../src/matrixrtc/RoomAndToDeviceKeyTransport.ts"],"sourcesContent":["/*\nCopyright 2025 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { logger as rootLogger, type Logger } from \"../logger.ts\";\nimport { KeyTransportEvents, type KeyTransportEventsHandlerMap, type IKeyTransport } from \"./IKeyTransport.ts\";\nimport { type CallMembership } from \"./CallMembership.ts\";\nimport type { RoomKeyTransport } from \"./RoomKeyTransport.ts\";\nimport { NotSupportedError, type ToDeviceKeyTransport } from \"./ToDeviceKeyTransport.ts\";\nimport { TypedEventEmitter } from \"../models/typed-event-emitter.ts\";\n\n// Deprecate RoomAndToDeviceTransport: This whole class is only a stop gap until we remove RoomKeyTransport.\nexport interface EnabledTransports {\n    toDevice: boolean;\n    room: boolean;\n}\n\nexport enum RoomAndToDeviceEvents {\n    EnabledTransportsChanged = \"enabled_transports_changed\",\n}\nexport type RoomAndToDeviceEventsHandlerMap = {\n    [RoomAndToDeviceEvents.EnabledTransportsChanged]: (enabledTransports: EnabledTransports) => void;\n};\n/**\n * A custom transport that subscribes to room key events (via `RoomKeyTransport`) and to device key events (via: `ToDeviceKeyTransport`)\n * The public setEnabled method allows to turn one or the other on or off on the fly.\n * It will emit `RoomAndToDeviceEvents.EnabledTransportsChanged` if the enabled transport changes to allow comminitcating this to\n * the user in the ui.\n *\n * Since it will always subscribe to both (room and to device) but only emit for the enabled ones, it can detect\n * if a room key event was received and autoenable it.\n */\nexport class RoomAndToDeviceTransport\n    extends TypedEventEmitter<\n        KeyTransportEvents | RoomAndToDeviceEvents,\n        KeyTransportEventsHandlerMap & RoomAndToDeviceEventsHandlerMap\n    >\n    implements IKeyTransport\n{\n    private readonly logger: Logger;\n    private _enabled: EnabledTransports = { toDevice: true, room: false };\n    public constructor(\n        private toDeviceTransport: ToDeviceKeyTransport,\n        private roomKeyTransport: RoomKeyTransport,\n        parentLogger?: Logger,\n    ) {\n        super();\n        this.logger = (parentLogger ?? rootLogger).getChild(`[RoomAndToDeviceTransport]`);\n        // update parent loggers for the sub transports so filtering for `RoomAndToDeviceTransport` contains their logs too\n        this.toDeviceTransport.setParentLogger(this.logger);\n        this.roomKeyTransport.setParentLogger(this.logger);\n\n        this.roomKeyTransport.on(KeyTransportEvents.ReceivedKeys, (...props) => {\n            // Turn on the room transport if we receive a roomKey from another participant\n            // and disable the toDevice transport.\n            if (!this._enabled.room) {\n                this.logger.debug(\"Received room key, enabling room key transport, disabling toDevice transport\");\n                this.setEnabled({ toDevice: false, room: true });\n            }\n            this.emit(KeyTransportEvents.ReceivedKeys, ...props);\n        });\n        this.toDeviceTransport.on(KeyTransportEvents.ReceivedKeys, (...props) => {\n            if (this._enabled.toDevice) {\n                this.emit(KeyTransportEvents.ReceivedKeys, ...props);\n            } else {\n                this.logger.debug(\"To Device transport is disabled, ignoring received keys\");\n            }\n        });\n    }\n\n    /** Set which transport type should be used to send and receive keys.*/\n    public setEnabled(enabled: { toDevice: boolean; room: boolean }): void {\n        if (this.enabled.toDevice !== enabled.toDevice || this.enabled.room !== enabled.room) {\n            this._enabled = enabled;\n            this.emit(RoomAndToDeviceEvents.EnabledTransportsChanged, enabled);\n        }\n    }\n\n    /** The currently enabled transports that are used to send and receive keys.*/\n    public get enabled(): EnabledTransports {\n        return this._enabled;\n    }\n\n    public start(): void {\n        // always start the underlying transport since we need to enable room transport\n        // when someone else sends us a room key. (we need to listen to roomKeyTransport)\n        this.roomKeyTransport.start();\n        this.toDeviceTransport.start();\n    }\n\n    public stop(): void {\n        // always stop since it is always running\n        this.roomKeyTransport.stop();\n        this.toDeviceTransport.stop();\n    }\n\n    public async sendKey(keyBase64Encoded: string, index: number, members: CallMembership[]): Promise<void> {\n        this.logger.debug(\n            `Sending key with index ${index} to call members (count=${members.length}) via:` +\n                (this._enabled.room ? \"room transport\" : \"\") +\n                (this._enabled.room && this._enabled.toDevice ? \"and\" : \"\") +\n                (this._enabled.toDevice ? \"to device transport\" : \"\"),\n        );\n        if (this._enabled.room) await this.roomKeyTransport.sendKey(keyBase64Encoded, index, members);\n        if (this._enabled.toDevice) {\n            try {\n                await this.toDeviceTransport.sendKey(keyBase64Encoded, index, members);\n            } catch (error) {\n                if (error instanceof NotSupportedError && !this._enabled.room) {\n                    this.logger.warn(\n                        \"To device is not supported enabling room key transport, disabling toDevice transport\",\n                    );\n                    this.setEnabled({ toDevice: false, room: true });\n                    await this.sendKey(keyBase64Encoded, index, members);\n                }\n            }\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]}