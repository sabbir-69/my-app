{"version":3,"file":"compare-event-ordering.js","names":["inMainTimelineForReceipt","threadIdForReceipt","compareEventOrdering","room","leftEventId","rightEventId","leftEvent","findEventById","rightEvent","isLeftEventInMainTimeline","isRightEventInMainTimeline","compareEventsInMainTimeline","compareEventsInThreads","timelineSet","getUnfilteredTimelineSet","compareSameTimeline","leftTimeline","getTimelineForEvent","getLiveTimeline","rightTimeline","guessOrderBasedOnTimestamp","leftEventThreadId","rightEventThreadId","leftThread","getThread","leftTs","getTs","rightTs"],"sources":["../../src/models/compare-event-ordering.ts"],"sourcesContent":["/*\nCopyright 2023 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { type MatrixEvent } from \"./event.ts\";\nimport { type Room } from \"./room.ts\";\nimport { inMainTimelineForReceipt, threadIdForReceipt } from \"../client.ts\";\n\n/**\n * Determine the order of two events in a room.\n *\n * In principle this should use the same order as the server, but in practice\n * this is difficult for events that were not received over the Sync API. See\n * MSC4033 for details.\n *\n * This implementation leans on the order of events within their timelines, and\n * falls back to comparing event timestamps when they are in different\n * timelines.\n *\n * See https://github.com/matrix-org/matrix-js-sdk/issues/3325 for where we are\n * tracking the work to fix this.\n *\n * @param room - the room we are looking in\n * @param leftEventId - the id of the first event\n * @param rightEventId - the id of the second event\n\n * @returns -1 if left \\< right, 1 if left \\> right, 0 if left == right, null if\n *          we can't tell (because we can't find the events).\n */\nexport function compareEventOrdering(room: Room, leftEventId: string, rightEventId: string): number | null {\n    const leftEvent = room.findEventById(leftEventId);\n    const rightEvent = room.findEventById(rightEventId);\n\n    if (!leftEvent || !rightEvent) {\n        // Without the events themselves, we can't find their thread or\n        // timeline, or guess based on timestamp, so we just don't know.\n        return null;\n    }\n\n    // Check whether the events are in the main timeline\n    const isLeftEventInMainTimeline = inMainTimelineForReceipt(leftEvent);\n    const isRightEventInMainTimeline = inMainTimelineForReceipt(rightEvent);\n\n    if (isLeftEventInMainTimeline && isRightEventInMainTimeline) {\n        return compareEventsInMainTimeline(room, leftEventId, rightEventId, leftEvent, rightEvent);\n    } else {\n        // At least one event is not in the timeline, so we can't use the room's\n        // unfiltered timeline set.\n        return compareEventsInThreads(leftEventId, rightEventId, leftEvent, rightEvent);\n    }\n}\n\nfunction compareEventsInMainTimeline(\n    room: Room,\n    leftEventId: string,\n    rightEventId: string,\n    leftEvent: MatrixEvent,\n    rightEvent: MatrixEvent,\n): number | null {\n    // Get the timeline set that contains all the events.\n    const timelineSet = room.getUnfilteredTimelineSet();\n\n    // If they are in the same timeline, compareEventOrdering does what we need\n    const compareSameTimeline = timelineSet.compareEventOrdering(leftEventId, rightEventId);\n    if (compareSameTimeline !== null) {\n        return compareSameTimeline;\n    }\n\n    // Find which timeline each event is in. Refuse to provide an ordering if we\n    // can't find either of the events.\n\n    const leftTimeline = timelineSet.getTimelineForEvent(leftEventId);\n    if (leftTimeline === timelineSet.getLiveTimeline()) {\n        // The left event is part of the live timeline, so it must be after the\n        // right event (since they are not in the same timeline or we would have\n        // returned after compareEventOrdering.\n        return 1;\n    }\n\n    const rightTimeline = timelineSet.getTimelineForEvent(rightEventId);\n    if (rightTimeline === timelineSet.getLiveTimeline()) {\n        // The right event is part of the live timeline, so it must be after the\n        // left event.\n        return -1;\n    }\n\n    // They are in older timeline sets (because they were fetched by paging up).\n    return guessOrderBasedOnTimestamp(leftEvent, rightEvent);\n}\n\nfunction compareEventsInThreads(\n    leftEventId: string,\n    rightEventId: string,\n    leftEvent: MatrixEvent,\n    rightEvent: MatrixEvent,\n): number | null {\n    const leftEventThreadId = threadIdForReceipt(leftEvent);\n    const rightEventThreadId = threadIdForReceipt(rightEvent);\n\n    const leftThread = leftEvent.getThread();\n\n    if (leftThread && leftEventThreadId === rightEventThreadId) {\n        // They are in the same thread, so we can ask the thread's timeline to\n        // figure it out for us\n        return leftThread.timelineSet.compareEventOrdering(leftEventId, rightEventId);\n    } else {\n        return guessOrderBasedOnTimestamp(leftEvent, rightEvent);\n    }\n}\n\n/**\n * Guess the order of events based on server timestamp. This is not good, but\n * difficult to avoid without MSC4033.\n *\n * See https://github.com/matrix-org/matrix-js-sdk/issues/3325\n */\nfunction guessOrderBasedOnTimestamp(leftEvent: MatrixEvent, rightEvent: MatrixEvent): number {\n    const leftTs = leftEvent.getTs();\n    const rightTs = rightEvent.getTs();\n    if (leftTs < rightTs) {\n        return -1;\n    } else if (leftTs > rightTs) {\n        return 1;\n    } else {\n        return 0;\n    }\n}\n"],"mappings":"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","ignoreList":[]}