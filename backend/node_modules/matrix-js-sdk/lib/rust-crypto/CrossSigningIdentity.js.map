{"version":3,"file":"CrossSigningIdentity.js","names":["logger","CrossSigningIdentity","constructor","olmMachine","outgoingRequestProcessor","secretStorage","bootstrapCrossSigning","opts","_this","_asyncToGenerator","setupNewCrossSigning","resetCrossSigning","authUploadDeviceSigningKeys","olmDeviceStatus","crossSigningStatus","masterKeyFromSecretStorage","get","selfSigningKeyFromSecretStorage","userSigningKeyFromSecretStorage","privateKeysInSecretStorage","Boolean","olmDeviceHasKeys","hasMaster","hasUserSigning","hasSelfSigning","log","olmDeviceHasMaster","olmDeviceHasUserSigning","olmDeviceHasSelfSigning","hasKey","warn","exportCrossSigningKeysToStorage","status","importCrossSigningKeys","Error","device","getDevice","userId","deviceId","request","verify","makeOutgoingRequest","free","_this2","outgoingRequests","req","uploadKeysRequest","uploadSigningKeysRequest","uploadSignaturesRequest","_this3","exported","exportCrossSigningKeys","masterKey","store","error","self_signing_key","userSigningKey"],"sources":["../../src/rust-crypto/CrossSigningIdentity.ts"],"sourcesContent":["/*\nCopyright 2023 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport {\n    type OlmMachine,\n    type CrossSigningStatus,\n    type CrossSigningBootstrapRequests,\n} from \"@matrix-org/matrix-sdk-crypto-wasm\";\n\nimport type * as RustSdkCryptoJs from \"@matrix-org/matrix-sdk-crypto-wasm\";\nimport { type BootstrapCrossSigningOpts } from \"../crypto-api/index.ts\";\nimport { logger } from \"../logger.ts\";\nimport { type OutgoingRequestProcessor } from \"./OutgoingRequestProcessor.ts\";\nimport { type UIAuthCallback } from \"../interactive-auth.ts\";\nimport { type ServerSideSecretStorage } from \"../secret-storage.ts\";\n\n/** Manages the cross-signing keys for our own user.\n *\n * @internal\n */\nexport class CrossSigningIdentity {\n    public constructor(\n        private readonly olmMachine: OlmMachine,\n        private readonly outgoingRequestProcessor: OutgoingRequestProcessor,\n        private readonly secretStorage: ServerSideSecretStorage,\n    ) {}\n\n    /**\n     * Initialise our cross-signing keys by creating new keys if they do not exist, and uploading to the server\n     */\n    public async bootstrapCrossSigning(opts: BootstrapCrossSigningOpts): Promise<void> {\n        if (opts.setupNewCrossSigning) {\n            await this.resetCrossSigning(opts.authUploadDeviceSigningKeys);\n            return;\n        }\n\n        const olmDeviceStatus: CrossSigningStatus = await this.olmMachine.crossSigningStatus();\n\n        // Try to fetch cross signing keys from the secret storage\n        const masterKeyFromSecretStorage = await this.secretStorage.get(\"m.cross_signing.master\");\n        const selfSigningKeyFromSecretStorage = await this.secretStorage.get(\"m.cross_signing.self_signing\");\n        const userSigningKeyFromSecretStorage = await this.secretStorage.get(\"m.cross_signing.user_signing\");\n        const privateKeysInSecretStorage = Boolean(\n            masterKeyFromSecretStorage && selfSigningKeyFromSecretStorage && userSigningKeyFromSecretStorage,\n        );\n\n        const olmDeviceHasKeys =\n            olmDeviceStatus.hasMaster && olmDeviceStatus.hasUserSigning && olmDeviceStatus.hasSelfSigning;\n\n        // Log all relevant state for easier parsing of debug logs.\n        logger.log(\"bootstrapCrossSigning: starting\", {\n            setupNewCrossSigning: opts.setupNewCrossSigning,\n            olmDeviceHasMaster: olmDeviceStatus.hasMaster,\n            olmDeviceHasUserSigning: olmDeviceStatus.hasUserSigning,\n            olmDeviceHasSelfSigning: olmDeviceStatus.hasSelfSigning,\n            privateKeysInSecretStorage,\n        });\n\n        if (olmDeviceHasKeys) {\n            if (!(await this.secretStorage.hasKey())) {\n                logger.warn(\n                    \"bootstrapCrossSigning: Olm device has private keys, but secret storage is not yet set up; doing nothing for now.\",\n                );\n                // the keys should get uploaded to 4S once that is set up.\n            } else if (!privateKeysInSecretStorage) {\n                // the device has the keys but they are not in 4S, so update it\n                logger.log(\"bootstrapCrossSigning: Olm device has private keys: exporting to secret storage\");\n                await this.exportCrossSigningKeysToStorage();\n            } else {\n                logger.log(\n                    \"bootstrapCrossSigning: Olm device has private keys and they are saved in secret storage; doing nothing\",\n                );\n            }\n        } /* (!olmDeviceHasKeys) */ else {\n            if (privateKeysInSecretStorage) {\n                // they are in 4S, so import from there\n                logger.log(\n                    \"bootstrapCrossSigning: Cross-signing private keys not found locally, but they are available \" +\n                        \"in secret storage, reading storage and caching locally\",\n                );\n                const status = await this.olmMachine.importCrossSigningKeys(\n                    masterKeyFromSecretStorage,\n                    selfSigningKeyFromSecretStorage,\n                    userSigningKeyFromSecretStorage,\n                );\n\n                // Check that `importCrossSigningKeys` worked correctly (for example, it will fail silently if the\n                // public keys are not available).\n                if (!status.hasMaster || !status.hasSelfSigning || !status.hasUserSigning) {\n                    throw new Error(\"importCrossSigningKeys failed to import the keys\");\n                }\n\n                // Get the current device\n                const device: RustSdkCryptoJs.Device = (await this.olmMachine.getDevice(\n                    this.olmMachine.userId,\n                    this.olmMachine.deviceId,\n                ))!;\n                try {\n                    // Sign the device with our cross-signing key and upload the signature\n                    const request: RustSdkCryptoJs.SignatureUploadRequest = await device.verify();\n                    await this.outgoingRequestProcessor.makeOutgoingRequest(request);\n                } finally {\n                    device.free();\n                }\n            } else {\n                logger.log(\n                    \"bootstrapCrossSigning: Cross-signing private keys not found locally or in secret storage, creating new keys\",\n                );\n                await this.resetCrossSigning(opts.authUploadDeviceSigningKeys);\n            }\n        }\n\n        // TODO: we might previously have bootstrapped cross-signing but not completed uploading the keys to the\n        //   server -- in which case we should call OlmDevice.bootstrap_cross_signing. How do we know?\n        logger.log(\"bootstrapCrossSigning: complete\");\n    }\n\n    /** Reset our cross-signing keys\n     *\n     * This method will:\n     *   * Tell the OlmMachine to create new keys\n     *   * Upload the new public keys and the device signature to the server\n     *   * Upload the private keys to SSSS, if it is set up\n     */\n    private async resetCrossSigning(authUploadDeviceSigningKeys?: UIAuthCallback<void>): Promise<void> {\n        // XXX: We must find a way to make this atomic, currently if the user does not remember his account password\n        // or 4S passphrase/key the process will fail in a bad state, with keys rotated but not uploaded or saved in 4S.\n        const outgoingRequests: CrossSigningBootstrapRequests = await this.olmMachine.bootstrapCrossSigning(true);\n\n        // If 4S is configured we need to update it.\n        if (!(await this.secretStorage.hasKey())) {\n            logger.warn(\n                \"resetCrossSigning: Secret storage is not yet set up; not exporting keys to secret storage yet.\",\n            );\n            // the keys should get uploaded to 4S once that is set up.\n        } else {\n            // Update 4S before uploading cross-signing keys, to stay consistent with legacy that asks\n            // 4S passphrase before asking for account password.\n            // Ultimately should be made atomic and resistant to forgotten password/passphrase.\n            logger.log(\"resetCrossSigning: exporting private keys to secret storage\");\n            await this.exportCrossSigningKeysToStorage();\n        }\n\n        logger.log(\"resetCrossSigning: publishing public keys to server\");\n        for (const req of [\n            outgoingRequests.uploadKeysRequest,\n            outgoingRequests.uploadSigningKeysRequest,\n            outgoingRequests.uploadSignaturesRequest,\n        ]) {\n            if (req) {\n                await this.outgoingRequestProcessor.makeOutgoingRequest(req, authUploadDeviceSigningKeys);\n            }\n        }\n    }\n\n    /**\n     * Extract the cross-signing keys from the olm machine and save them to secret storage, if it is configured\n     *\n     * (If secret storage is *not* configured, we assume that the export will happen when it is set up)\n     */\n    private async exportCrossSigningKeysToStorage(): Promise<void> {\n        const exported: RustSdkCryptoJs.CrossSigningKeyExport | undefined =\n            await this.olmMachine.exportCrossSigningKeys();\n        /* istanbul ignore else (this function is only called when we know the olm machine has keys) */\n        if (exported?.masterKey) {\n            await this.secretStorage.store(\"m.cross_signing.master\", exported.masterKey);\n        } else {\n            logger.error(`Cannot export MSK to secret storage, private key unknown`);\n        }\n        if (exported?.self_signing_key) {\n            await this.secretStorage.store(\"m.cross_signing.self_signing\", exported.self_signing_key);\n        } else {\n            logger.error(`Cannot export SSK to secret storage, private key unknown`);\n        }\n        if (exported?.userSigningKey) {\n            await this.secretStorage.store(\"m.cross_signing.user_signing\", exported.userSigningKey);\n        } else {\n            logger.error(`Cannot export USK to secret storage, private key unknown`);\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]}