{"version":3,"file":"recovery-key.js","names":["bs58","OLM_RECOVERY_KEY_PREFIX","KEY_SIZE","encodeRecoveryKey","key","_base58key$match","buf","Uint8Array","length","set","parity","i","base58key","encode","match","join","decodeRecoveryKey","recoveryKey","result","decode","replace","b","Error","from","slice"],"sources":["../../src/crypto-api/recovery-key.ts"],"sourcesContent":["/*\n * Copyright 2024 The Matrix.org Foundation C.I.C.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport bs58 from \"bs58\";\n\n// picked arbitrarily but to try & avoid clashing with any bitcoin ones\n// (which are also base58 encoded, but bitcoin's involve a lot more hashing)\nconst OLM_RECOVERY_KEY_PREFIX = [0x8b, 0x01];\nconst KEY_SIZE = 32;\n\n/**\n * Encode a recovery key using the Matrix {@link https://spec.matrix.org/v1.11/appendices/#cryptographic-key-representation | Cryptographic key representation}\n * @param key\n */\nexport function encodeRecoveryKey(key: ArrayLike<number>): string | undefined {\n    const buf = new Uint8Array(OLM_RECOVERY_KEY_PREFIX.length + key.length + 1);\n    buf.set(OLM_RECOVERY_KEY_PREFIX, 0);\n    buf.set(key, OLM_RECOVERY_KEY_PREFIX.length);\n\n    let parity = 0;\n    for (let i = 0; i < buf.length - 1; ++i) {\n        parity ^= buf[i];\n    }\n    buf[buf.length - 1] = parity;\n    const base58key = bs58.encode(buf);\n\n    return base58key.match(/.{1,4}/g)?.join(\" \");\n}\n\n/**\n * Decode a recovery key encoded with the Matrix {@link https://spec.matrix.org/v1.11/appendices/#cryptographic-key-representation | Cryptographic key representation} encoding.\n * @param recoveryKey\n */\nexport function decodeRecoveryKey(recoveryKey: string): Uint8Array {\n    const result = bs58.decode(recoveryKey.replace(/ /g, \"\"));\n\n    let parity = 0;\n    for (const b of result) {\n        parity ^= b;\n    }\n    if (parity !== 0) {\n        throw new Error(\"Incorrect parity\");\n    }\n\n    for (let i = 0; i < OLM_RECOVERY_KEY_PREFIX.length; ++i) {\n        if (result[i] !== OLM_RECOVERY_KEY_PREFIX[i]) {\n            throw new Error(\"Incorrect prefix\");\n        }\n    }\n\n    if (result.length !== OLM_RECOVERY_KEY_PREFIX.length + KEY_SIZE + 1) {\n        throw new Error(\"Incorrect length\");\n    }\n\n    return Uint8Array.from(result.slice(OLM_RECOVERY_KEY_PREFIX.length, OLM_RECOVERY_KEY_PREFIX.length + KEY_SIZE));\n}\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,OAAOA,IAAI,MAAM,MAAM;;AAEvB;AACA;AACA,IAAMC,uBAAuB,GAAG,CAAC,IAAI,EAAE,IAAI,CAAC;AAC5C,IAAMC,QAAQ,GAAG,EAAE;;AAEnB;AACA;AACA;AACA;AACA,OAAO,SAASC,iBAAiBA,CAACC,GAAsB,EAAsB;EAAA,IAAAC,gBAAA;EAC1E,IAAMC,GAAG,GAAG,IAAIC,UAAU,CAACN,uBAAuB,CAACO,MAAM,GAAGJ,GAAG,CAACI,MAAM,GAAG,CAAC,CAAC;EAC3EF,GAAG,CAACG,GAAG,CAACR,uBAAuB,EAAE,CAAC,CAAC;EACnCK,GAAG,CAACG,GAAG,CAACL,GAAG,EAAEH,uBAAuB,CAACO,MAAM,CAAC;EAE5C,IAAIE,MAAM,GAAG,CAAC;EACd,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGL,GAAG,CAACE,MAAM,GAAG,CAAC,EAAE,EAAEG,CAAC,EAAE;IACrCD,MAAM,IAAIJ,GAAG,CAACK,CAAC,CAAC;EACpB;EACAL,GAAG,CAACA,GAAG,CAACE,MAAM,GAAG,CAAC,CAAC,GAAGE,MAAM;EAC5B,IAAME,SAAS,GAAGZ,IAAI,CAACa,MAAM,CAACP,GAAG,CAAC;EAElC,QAAAD,gBAAA,GAAOO,SAAS,CAACE,KAAK,CAAC,SAAS,CAAC,cAAAT,gBAAA,uBAA1BA,gBAAA,CAA4BU,IAAI,CAAC,GAAG,CAAC;AAChD;;AAEA;AACA;AACA;AACA;AACA,OAAO,SAASC,iBAAiBA,CAACC,WAAmB,EAAc;EAC/D,IAAMC,MAAM,GAAGlB,IAAI,CAACmB,MAAM,CAACF,WAAW,CAACG,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;EAEzD,IAAIV,MAAM,GAAG,CAAC;EACd,KAAK,IAAMW,CAAC,IAAIH,MAAM,EAAE;IACpBR,MAAM,IAAIW,CAAC;EACf;EACA,IAAIX,MAAM,KAAK,CAAC,EAAE;IACd,MAAM,IAAIY,KAAK,CAAC,kBAAkB,CAAC;EACvC;EAEA,KAAK,IAAIX,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGV,uBAAuB,CAACO,MAAM,EAAE,EAAEG,CAAC,EAAE;IACrD,IAAIO,MAAM,CAACP,CAAC,CAAC,KAAKV,uBAAuB,CAACU,CAAC,CAAC,EAAE;MAC1C,MAAM,IAAIW,KAAK,CAAC,kBAAkB,CAAC;IACvC;EACJ;EAEA,IAAIJ,MAAM,CAACV,MAAM,KAAKP,uBAAuB,CAACO,MAAM,GAAGN,QAAQ,GAAG,CAAC,EAAE;IACjE,MAAM,IAAIoB,KAAK,CAAC,kBAAkB,CAAC;EACvC;EAEA,OAAOf,UAAU,CAACgB,IAAI,CAACL,MAAM,CAACM,KAAK,CAACvB,uBAAuB,CAACO,MAAM,EAAEP,uBAAuB,CAACO,MAAM,GAAGN,QAAQ,CAAC,CAAC;AACnH","ignoreList":[]}