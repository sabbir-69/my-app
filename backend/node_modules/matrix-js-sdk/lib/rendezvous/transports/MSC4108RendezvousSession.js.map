{"version":3,"file":"MSC4108RendezvousSession.js","names":["logger","sleep","ClientRendezvousFailureReason","MSC4108FailureReason","Method","ClientPrefix","MSC4108RendezvousSession","constructor","_ref","fetchFn","onFailure","url","client","fallbackRzServer","_defineProperty","ready","_ready","cancelled","_cancelled","fetch","resource","options","globalThis","getPostEndpoint","_this","_asyncToGenerator","doesServerSupportUnstableFeature","http","getUrl","undefined","Unstable","toString","err","warn","send","data","_this2","_this2$url","_res$headers$get","method","Put","Post","uri","Error","headers","etag","receive","info","concat","res","body","redirect","status","cancel","Unknown","get","expires","expiresTimer","clearTimeout","expiresAt","Date","setTimeout","Expired","getTime","now","json","_this3","_poll$headers$get","poll","Get","ETagMissing","text","reason","_this4","_this4$onFailure","call","UserDeclined","UserCancelled","close","_this5","Delete","e"],"sources":["../../../src/rendezvous/transports/MSC4108RendezvousSession.ts"],"sourcesContent":["/*\nCopyright 2024 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { logger } from \"../../logger.ts\";\nimport { sleep } from \"../../utils.ts\";\nimport { ClientRendezvousFailureReason, MSC4108FailureReason, type RendezvousFailureListener } from \"../index.ts\";\nimport { type MatrixClient, Method } from \"../../matrix.ts\";\nimport { ClientPrefix } from \"../../http-api/index.ts\";\n\n/**\n * Prototype of the unstable [MSC4108](https://github.com/matrix-org/matrix-spec-proposals/pull/4108)\n * insecure rendezvous session protocol.\n * @experimental Note that this is UNSTABLE and may have breaking changes without notice.\n */\nexport class MSC4108RendezvousSession {\n    public url?: string;\n    private readonly client?: MatrixClient;\n    private readonly fallbackRzServer?: string;\n    private readonly fetchFn?: typeof globalThis.fetch;\n    private readonly onFailure?: RendezvousFailureListener;\n    private etag?: string;\n    private expiresAt?: Date;\n    private expiresTimer?: ReturnType<typeof setTimeout>;\n    private _cancelled = false;\n    private _ready = false;\n\n    public constructor({\n        onFailure,\n        url,\n        fetchFn,\n    }: {\n        fetchFn?: typeof globalThis.fetch;\n        onFailure?: RendezvousFailureListener;\n        url: string;\n    });\n    public constructor({\n        onFailure,\n        client,\n        fallbackRzServer,\n        fetchFn,\n    }: {\n        fetchFn?: typeof globalThis.fetch;\n        onFailure?: RendezvousFailureListener;\n        client?: MatrixClient;\n        fallbackRzServer?: string;\n    });\n    public constructor({\n        fetchFn,\n        onFailure,\n        url,\n        client,\n        fallbackRzServer,\n    }: {\n        fetchFn?: typeof globalThis.fetch;\n        onFailure?: RendezvousFailureListener;\n        url?: string;\n        client?: MatrixClient;\n        fallbackRzServer?: string;\n    }) {\n        this.fetchFn = fetchFn;\n        this.onFailure = onFailure;\n        this.client = client;\n        this.fallbackRzServer = fallbackRzServer;\n        this.url = url;\n    }\n\n    /**\n     * Returns whether the channel is ready to be used.\n     */\n    public get ready(): boolean {\n        return this._ready;\n    }\n\n    /**\n     * Returns whether the channel has been cancelled.\n     */\n    public get cancelled(): boolean {\n        return this._cancelled;\n    }\n\n    private fetch(resource: URL | string, options?: RequestInit): ReturnType<typeof globalThis.fetch> {\n        if (this.fetchFn) {\n            return this.fetchFn(resource, options);\n        }\n        return globalThis.fetch(resource, options);\n    }\n\n    private async getPostEndpoint(): Promise<string | undefined> {\n        if (this.client) {\n            try {\n                if (await this.client.doesServerSupportUnstableFeature(\"org.matrix.msc4108\")) {\n                    return this.client.http\n                        .getUrl(\"/org.matrix.msc4108/rendezvous\", undefined, ClientPrefix.Unstable)\n                        .toString();\n                }\n            } catch (err) {\n                logger.warn(\"Failed to get unstable features\", err);\n            }\n        }\n\n        return this.fallbackRzServer;\n    }\n\n    /**\n     * Sends data via the rendezvous channel.\n     * @param data the payload to send\n     */\n    public async send(data: string): Promise<void> {\n        if (this._cancelled) {\n            return;\n        }\n        const method = this.url ? Method.Put : Method.Post;\n        const uri = this.url ?? (await this.getPostEndpoint());\n\n        if (!uri) {\n            throw new Error(\"Invalid rendezvous URI\");\n        }\n\n        const headers: Record<string, string> = { \"content-type\": \"text/plain\" };\n\n        // if we didn't create the rendezvous channel, we need to fetch the first etag if needed\n        if (!this.etag && this.url) {\n            await this.receive();\n        }\n\n        if (this.etag) {\n            headers[\"if-match\"] = this.etag;\n        }\n\n        logger.info(`=> ${method} ${uri} with ${data} if-match: ${this.etag}`);\n\n        const res = await this.fetch(uri, { method, headers, body: data, redirect: \"follow\" });\n        if (res.status === 404) {\n            return this.cancel(ClientRendezvousFailureReason.Unknown);\n        }\n        this.etag = res.headers.get(\"etag\") ?? undefined;\n\n        logger.info(`Received etag: ${this.etag}`);\n\n        if (method === Method.Post) {\n            const expires = res.headers.get(\"expires\");\n            if (expires) {\n                if (this.expiresTimer) {\n                    clearTimeout(this.expiresTimer);\n                    this.expiresTimer = undefined;\n                }\n                this.expiresAt = new Date(expires);\n                this.expiresTimer = setTimeout(() => {\n                    this.expiresTimer = undefined;\n                    this.cancel(ClientRendezvousFailureReason.Expired);\n                }, this.expiresAt.getTime() - Date.now());\n            }\n            // MSC4108: we expect a JSON response with a rendezvous URL\n            const json = await res.json();\n            if (typeof json.url !== \"string\") {\n                throw new Error(\"No rendezvous URL given\");\n            }\n            this.url = json.url;\n            this._ready = true;\n        }\n    }\n\n    /**\n     * Receives data from the rendezvous channel.\n     * @return the returned promise won't resolve until new data is acquired or the channel is closed either by the server or the other party.\n     */\n    public async receive(): Promise<string | undefined> {\n        if (!this.url) {\n            throw new Error(\"Rendezvous not set up\");\n        }\n        // eslint-disable-next-line no-constant-condition\n        while (true) {\n            if (this._cancelled) {\n                return undefined;\n            }\n\n            const headers: Record<string, string> = {};\n            if (this.etag) {\n                headers[\"if-none-match\"] = this.etag;\n            }\n\n            logger.info(`=> GET ${this.url} if-none-match: ${this.etag}`);\n            const poll = await this.fetch(this.url, { method: Method.Get, headers });\n\n            if (poll.status === 404) {\n                await this.cancel(ClientRendezvousFailureReason.Unknown);\n                return undefined;\n            }\n\n            // rely on server expiring the channel rather than checking ourselves\n\n            const etag = poll.headers.get(\"etag\") ?? undefined;\n            if (poll.headers.get(\"content-type\") !== \"text/plain\") {\n                this.etag = etag;\n            } else if (poll.status === 200) {\n                if (!etag) {\n                    // Some browsers & extensions block the ETag header for anti-tracking purposes\n                    // We try and detect this so the client can give the user a somewhat helpful message\n                    await this.cancel(ClientRendezvousFailureReason.ETagMissing);\n                    return undefined;\n                }\n\n                this.etag = etag;\n                const text = await poll.text();\n                logger.info(`Received: ${text} with etag ${this.etag}`);\n                return text;\n            }\n            await sleep(1000);\n        }\n    }\n\n    /**\n     * Cancels the rendezvous channel.\n     * If the reason is user_declined or user_cancelled then the channel will also be closed.\n     * @param reason the reason to cancel with\n     */\n    public async cancel(reason: MSC4108FailureReason | ClientRendezvousFailureReason): Promise<void> {\n        if (this._cancelled) return;\n        if (this.expiresTimer) {\n            clearTimeout(this.expiresTimer);\n            this.expiresTimer = undefined;\n        }\n\n        if (\n            reason === ClientRendezvousFailureReason.Unknown &&\n            this.expiresAt &&\n            this.expiresAt.getTime() < Date.now()\n        ) {\n            reason = ClientRendezvousFailureReason.Expired;\n        }\n\n        this._cancelled = true;\n        this._ready = false;\n        this.onFailure?.(reason);\n\n        if (reason === ClientRendezvousFailureReason.UserDeclined || reason === MSC4108FailureReason.UserCancelled) {\n            await this.close();\n        }\n    }\n\n    /**\n     * Closes the rendezvous channel.\n     */\n    public async close(): Promise<void> {\n        if (this.expiresTimer) {\n            clearTimeout(this.expiresTimer);\n            this.expiresTimer = undefined;\n        }\n\n        if (!this.url) return;\n        try {\n            await this.fetch(this.url, { method: Method.Delete });\n        } catch (e) {\n            logger.warn(e);\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]}