{"version":3,"file":"logger.js","names":["loglevel","DEFAULT_NAMESPACE","methodFactory","methodName","logLevel","loggerName","_len","arguments","length","args","Array","_key","prefix","unshift","supportedByConsole","console","log","getPrefixedLogger","undefined","concat","prefixLogger","getLogger","getChild","childPrefix","childLogger","rebuild","setLevel","levels","DEBUG","logger","LogSpan","constructor","parent","name","_defineProperty","trace","_len2","msg","_key2","debug","_len3","_key3","info","_len4","_key4","warn","_len5","_key5","error","_len6","_key6"],"sources":["../src/logger.ts"],"sourcesContent":["/*\nCopyright 2018 AndrÃ© Jaenisch\nCopyright 2019, 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport loglevel from \"loglevel\";\n\n/** Backwards-compatibility hack to expose `log` to applications that might still be relying on it. */\ninterface LoggerWithLogMethod extends Logger {\n    /**\n     * Output debug message to the logger.\n     *\n     * @param msg - Data to log.\n     *\n     * @deprecated prefer {@link Logger.debug}.\n     */\n    log(...msg: any[]): void;\n}\n\n/** Logger interface used within the js-sdk codebase */\nexport interface Logger extends BaseLogger {\n    /**\n     * Create a child logger.\n     *\n     * This child will use the `methodFactory` of the parent, so any log extensions applied to the parent\n     * at the time of calling `getChild` will be applied to the child as well.\n     * It will NOT apply changes to the parent's `methodFactory` after the child was created.\n     * Those changes need to be applied to the child manually.\n     *\n     * @param namespace - name to add to the current logger to generate the child. Some implementations of `Logger`\n     *    use this as a prefix; others use a different mechanism.\n     */\n    getChild(namespace: string): Logger;\n}\n\n/** The basic interface for a logger which doesn't support children */\nexport interface BaseLogger {\n    /**\n     * Output trace message to the logger, with stack trace.\n     *\n     * @param msg - Data to log.\n     */\n    trace(...msg: any[]): void;\n\n    /**\n     * Output debug message to the logger.\n     *\n     * @param msg - Data to log.\n     */\n    debug(...msg: any[]): void;\n\n    /**\n     * Output info message to the logger.\n     *\n     * @param msg - Data to log.\n     */\n    info(...msg: any[]): void;\n\n    /**\n     * Output warn message to the logger.\n     *\n     * @param msg - Data to log.\n     */\n    warn(...msg: any[]): void;\n\n    /**\n     * Output error message to the logger.\n     *\n     * @param msg - Data to log.\n     */\n    error(...msg: any[]): void;\n}\n\n// This is to demonstrate, that you can use any namespace you want.\n// Namespaces allow you to turn on/off the logging for specific parts of the\n// application.\n// An idea would be to control this via an environment variable (on Node.js).\n// See https://www.npmjs.com/package/debug to see how this could be implemented\n// Part of #332 is introducing a logging library in the first place.\nconst DEFAULT_NAMESPACE = \"matrix\";\n\n// because rageshakes in react-sdk hijack the console log, also at module load time,\n// initializing the logger here races with the initialization of rageshakes.\n// to avoid the issue, we override the methodFactory of loglevel that binds to the\n// console methods at initialization time by a factory that looks up the console methods\n// when logging so we always get the current value of console methods.\nloglevel.methodFactory = function (methodName, logLevel, loggerName) {\n    return function (this: PrefixedLogger, ...args): void {\n        /* eslint-disable @typescript-eslint/no-invalid-this */\n        if (this.prefix) {\n            args.unshift(this.prefix);\n        }\n        /* eslint-enable @typescript-eslint/no-invalid-this */\n        const supportedByConsole =\n            methodName === \"error\" ||\n            methodName === \"warn\" ||\n            methodName === \"trace\" ||\n            methodName === \"info\" ||\n            methodName === \"debug\";\n        /* eslint-disable no-console */\n        if (supportedByConsole) {\n            return console[methodName](...args);\n        } else {\n            return console.log(...args);\n        }\n        /* eslint-enable no-console */\n    };\n};\n\n/**\n * Implementation of {@link Logger} based on `loglevel`.\n */\ninterface PrefixedLogger extends loglevel.Logger, LoggerWithLogMethod {\n    prefix?: string;\n}\n\n/**\n * Internal utility function: gets a {@link Logger} based on `loglevel`.\n *\n * Child loggers produced by {@link Logger.getChild} add the name of the child logger as a prefix on each log line.\n *\n * @param prefix Prefix to add to each logged line. If undefined, no prefix will be added.\n */\nfunction getPrefixedLogger(prefix?: string): PrefixedLogger {\n    const loggerName = DEFAULT_NAMESPACE + (prefix === undefined ? \"\" : `-${prefix}`);\n    const prefixLogger = loglevel.getLogger(loggerName) as PrefixedLogger;\n\n    if (prefixLogger.getChild === undefined) {\n        // This is a new loglevel Logger which has not been turned into a PrefixedLogger yet.\n        prefixLogger.prefix = prefix;\n        prefixLogger.getChild = (childPrefix): Logger => {\n            // create the new child logger\n            const childLogger = getPrefixedLogger((prefix ?? \"\") + childPrefix);\n            // Assign the methodFactory from the parent logger.\n            // This is useful if we add extensions to the parent logger that modifies\n            // its methodFactory. (An example extension is: storing each log to a rageshake db)\n            childLogger.methodFactory = prefixLogger.methodFactory;\n            // Rebuild the child logger with the new methodFactory.\n            childLogger.rebuild();\n            return childLogger;\n        };\n        prefixLogger.setLevel(loglevel.levels.DEBUG, false);\n    }\n\n    return prefixLogger;\n}\n\n/**\n * Drop-in replacement for `console` using {@link https://www.npmjs.com/package/loglevel|loglevel}.\n * Can be tailored down to specific use cases if needed.\n */\nexport const logger = getPrefixedLogger() as LoggerWithLogMethod;\n\n/**\n * A \"span\" for grouping related log lines together.\n *\n * The current implementation just adds the name at the start of each log line.\n *\n * This offers a lighter-weight alternative to 'child' loggers returned by {@link Logger#getChild}. In particular,\n * it's not possible to apply individual filters to the LogSpan such as setting the verbosity level. On the other hand,\n * no reference to the LogSpan is retained in the logging framework, so it is safe to make lots of them over the course\n * of an application's life and just drop references to them when the job is done.\n */\nexport class LogSpan implements BaseLogger {\n    private readonly name;\n\n    public constructor(\n        private readonly parent: BaseLogger,\n        name: string,\n    ) {\n        this.name = name + \":\";\n    }\n\n    public trace(...msg: any[]): void {\n        this.parent.trace(this.name, ...msg);\n    }\n\n    public debug(...msg: any[]): void {\n        this.parent.debug(this.name, ...msg);\n    }\n\n    public info(...msg: any[]): void {\n        this.parent.info(this.name, ...msg);\n    }\n\n    public warn(...msg: any[]): void {\n        this.parent.warn(this.name, ...msg);\n    }\n\n    public error(...msg: any[]): void {\n        this.parent.error(this.name, ...msg);\n    }\n}\n"],"mappings":"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","ignoreList":[]}